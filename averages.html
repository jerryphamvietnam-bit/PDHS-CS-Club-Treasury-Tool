<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Charts from Transactions</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      background-color: #1F1F1F;
      color: #C1C1C1;
      text-align: left;
    }
    h1, p {
      color: #C1C1C1;
    }
  </style>
</head>
<body>

<h1>Averages</h1>
<p>Pie chart and line chart automatically generated from transactions</p>

<div id="piechart" style="width: 900px; height: 500px;"></div>
<div id="curve_chart" style="width: 900px; height: 500px;"></div>

<script type="text/javascript">
google.charts.load('current', {'packages':['corechart']});
google.charts.setOnLoadCallback(drawCharts);

function parseDate(dateStr) {
  if (!dateStr) return null;
  const s = String(dateStr).trim();
  if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(s)) {
    const [y, m, d] = s.split('-').map(Number);
    return new Date(y, m - 1, d);
  }
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) {
    const [mm, dd, yyyy] = s.split('/').map(Number);
    return new Date(yyyy, mm - 1, dd);
  }
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}

function drawCharts() {
  drawPieChart();
  drawLineChart();
}

function drawPieChart() {
  const raw = JSON.parse(localStorage.getItem("transactions")) || [];
  const totals = {};
  raw.forEach(t => {
    const amt = typeof t.amount === 'number' ? t.amount : parseFloat(t.amount) || 0;
    const type = t.type || 'Unknown';
    totals[type] = (totals[type] || 0) + amt;
  });

  const chartData = [['Type','Amount']];
  for (const key in totals) chartData.push([key, totals[key]]);

  const data = google.visualization.arrayToDataTable(chartData);

  const options = {
    title: 'Transactions by Type',
    backgroundColor: '#1F1F1F',
    titleTextStyle: { color: '#C1C1C1' },
    legendTextStyle: { color: '#C1C1C1' }
  };

  const chart = new google.visualization.PieChart(document.getElementById('piechart'));
  chart.draw(data, options);
}

function drawLineChart() {
  const raw = JSON.parse(localStorage.getItem("transactions")) || [];

  const parsed = raw.map(t => {
    return {
      dateObj: parseDate(t.date),
      amount: typeof t.amount === 'number' ? t.amount : parseFloat(t.amount) || 0,
      type: (t.type || '').toString()
    };
  }).filter(x => x.dateObj && !isNaN(x.dateObj.getTime()));

  if (parsed.length === 0) {
    const emptyData = google.visualization.arrayToDataTable([['Date','Balance ($)']]);
    const emptyOptions = {
      title: 'Balance Over Time',
      curveType: 'function',
      legend: { position: 'bottom' },
      backgroundColor: '#1F1F1F',
      titleTextStyle: { color: '#C1C1C1' },
      legendTextStyle: { color: '#C1C1C1' },
      hAxis: { title: 'Date', textStyle: { color: '#C1C1C1' }, titleTextStyle: { color: '#C1C1C1' } },
      vAxis: { title: 'Balance ($)', textStyle: { color: '#C1C1C1' }, titleTextStyle: { color: '#C1C1C1' } }
    };
    const chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
    chart.draw(emptyData, emptyOptions);
    return;
  }

  parsed.sort((a,b) => a.dateObj.getTime() - b.dateObj.getTime());

  const dataTable = new google.visualization.DataTable();
  dataTable.addColumn('date', 'Date');
  dataTable.addColumn('number', 'Balance ($)');

  let balance = 0;
  const rows = parsed.map(item => {
    if (item.type.toLowerCase() === 'funding') balance += item.amount;
    else balance -= item.amount;
    return [item.dateObj, balance];
  });

  dataTable.addRows(rows);

  const first = rows[0][0].getTime();
  const last = rows[rows.length - 1][0].getTime();
  const range = Math.max(1, last - first);
  const pad = Math.max(24*60*60*1000, Math.round(range * 0.03));

  const options = {
    title: 'Balance Over Time',
    curveType: 'function',
    legend: { position: 'bottom' },
    backgroundColor: '#1F1F1F',
    titleTextStyle: { color: '#C1C1C1' },
    legendTextStyle: { color: '#C1C1C1' },
    hAxis: {
      title: 'Date',
      format: 'MMM dd',
      textStyle: { color: '#C1C1C1' },
      titleTextStyle: { color: '#C1C1C1' },
      viewWindowMode: 'explicit',
      viewWindow: {
        min: new Date(first - pad),
        max: new Date(last + pad)
      }
    },
    vAxis: {
      title: 'Balance ($)',
      textStyle: { color: '#C1C1C1' },
      titleTextStyle: { color: '#C1C1C1' }
    }
  };

  const chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
  chart.draw(dataTable, options);
}

setInterval(drawCharts, 1000);
</script>

</body>
</html>
